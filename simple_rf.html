<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üöó Traffic Congestion Predictor (Random Forest)</title>
  <link rel="stylesheet" href="/static/traffic_style.css" />
</head>
<body>
  <!-- Background Effects -->
  <div class="fx fx-noise" aria-hidden="true"></div>
  <div class="fx fx-vignette" aria-hidden="true"></div>
  
  <!-- Traffic Mode Layers -->
  <div class="traffic sky traffic-gradient" aria-hidden="true"></div>
  <div class="traffic road-lines" aria-hidden="true"></div>
  <div class="traffic vehicles" aria-hidden="true"></div>
  <div class="traffic congestion-overlay" aria-hidden="true"></div>

  <!-- Main Container -->
  <section class="panel hero" id="hero">
    <div class="brand">
      <div class="logo">üöó</div>
      <div class="title">
        <h1>Traffic Congestion Predictor</h1>
        <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡∏à‡∏£‡∏≤‡∏à‡∏£‡∏ï‡∏¥‡∏î/‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î (Random Forest Model)</p>
      </div>
    </div>
    <div class="model-info">
      <span class="model-badge">üå≤ Random Forest</span>
    </div>
  </section>

  <!-- Excel Upload Section -->
  <section class="panel panel--compact">
    <h3 class="section-title">üìä ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel (‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏ö‡∏ö Batch)</h3>
    <form id="excel-upload-form" enctype="multipart/form-data" class="upload-inline">
      <label class="file-input-label">
        <input type="file" id="excel-file" accept=".xlsx,.xls" required>
        <span class="file-icon">üìÅ</span>
        <span class="file-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel</span>
      </label>
      <button type="submit" class="btn primary">üöÄ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </form>
    <div id="upload-result" class="upload-result"></div>
  </section>

  <!-- Main Prediction Section -->
  <section class="panel grid layout-two-cols">
    <form id="predict-form" class="card form">
      <h3 class="section-title">‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏£‡∏≤‡∏à‡∏£</h3>
      <div class="grid2">
        <label>Latitude <input type="number" step="any" id="latitude" value="13.7563"></label>
        <label>Longitude <input type="number" step="any" id="longitude" value="100.5018"></label>
        <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô (density) <input type="number" step="any" id="density" value="50"></label>
        <label>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏à‡∏£‡∏≤‡∏à‡∏£ (volume) <input type="number" step="any" id="volume" value="1500"></label>
        <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏ñ‡∏ô‡∏ô (capacity) <input type="number" step="any" id="capacity" value="2000"></label>
        <label>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (hour) <input type="number" min="0" max="23" id="hour" value="8"></label>
        <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß (speed km/h) <input type="number" step="any" id="speed" value="45"></label>
        <label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô v/c <input type="number" step="any" id="vc_ratio" value="0.75"></label>
      </div>
      <div class="actions">
        <button type="submit" class="btn primary">üîÆ ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏£‡∏≤‡∏à‡∏£</button>
        <button type="reset" class="btn ghost">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
      </div>
    </form>

    <div class="card result">
      <div class="result-header">
        <span class="badge">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</span>
        <div class="status-dot" id="statusDot"></div>
      </div>
      <div id="result" class="result-content">
        <div class="result-placeholder">[‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå]</div>
      </div>
      <div id="summary" class="summary"></div>
    </div>
  </section>

  <script>
    const resultEl = document.getElementById("result");
    const summaryEl = document.getElementById("summary");
    const statusDot = document.getElementById("statusDot");
    const body = document.body;

    // Submit prediction form
    document.getElementById("predict-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      const payload = {
        latitude: parseFloat(document.getElementById("latitude").value) || 13.7563,
        longitude: parseFloat(document.getElementById("longitude").value) || 100.5018,
        density: parseFloat(document.getElementById("density").value) || 0,
        volume: parseFloat(document.getElementById("volume").value) || 0,
        capacity: parseFloat(document.getElementById("capacity").value) || 1,
        hour: parseInt(document.getElementById("hour").value) || 12,
        speed: parseFloat(document.getElementById("speed").value) || 0,
        vc_ratio: parseFloat(document.getElementById("vc_ratio").value) || 0.75
      };

      statusDot.dataset.state = "loading";
      resultEl.innerHTML = '<div class="result-placeholder">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå...</div>';
      summaryEl.textContent = "";

      try {
        const res = await fetch("/predict-traffic", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();

        if (data.error) {
          statusDot.dataset.state = "error";
          resultEl.innerHTML = `<div class="error-message">‚ùå ${data.error}</div>`;
          return;
        }

        statusDot.dataset.state = "ok";
        
        // Display results
        const isCongested = data.traffic_prediction === 1;
        const isWeekend = data.day_type_prediction === 1;
        
        resultEl.innerHTML = `
          <div class="prediction-result">
            <div class="prediction-card ${isCongested ? 'congested' : 'free-flow'}">
              <div class="prediction-icon">${isCongested ? 'üö¶' : 'üü¢'}</div>
              <div class="prediction-text">
                <h4>${data.traffic_label}</h4>
                <p>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô: ${data.traffic_probabilities.‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î} / ${data.traffic_probabilities.‡∏ï‡∏¥‡∏î}</p>
              </div>
            </div>
            
            <div class="prediction-card ${isWeekend ? 'weekend' : 'weekday'}">
              <div class="prediction-icon">${isWeekend ? 'üèñÔ∏è' : 'üíº'}</div>
              <div class="prediction-text">
                <h4>${data.day_type_label}</h4>
              </div>
            </div>
            
            <div class="criteria-info">
              <h5>‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô:</h5>
              <ul>
                <li>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô v/c: ${data.vc_ratio.toFixed(3)} ${data.criteria_met.vc_ratio_over_1 ? '‚úÖ' : '‚ùå'}</li>
                <li>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß < 20 km/h: ${data.speed} km/h ${data.criteria_met.speed_under_20 ? '‚úÖ' : '‚ùå'}</li>
                <li>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏£‡∏¥‡∏á: ${data.actual_congested ? '‡∏ï‡∏¥‡∏î' : '‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î'}</li>
              </ul>
            </div>
          </div>
        `;

        // Update background based on traffic condition
        body.className = isCongested ? 'congested' : 'free-flow';

        let summaryText = `‡πÇ‡∏°‡πÄ‡∏î‡∏•: Random Forest | `;
        summaryText += `v/c = ${data.vc_ratio.toFixed(3)} | `;
        summaryText += `‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß = ${data.speed} km/h`;
        summaryEl.textContent = summaryText;

      } catch (err) {
        statusDot.dataset.state = "error";
        resultEl.innerHTML = `<div class="error-message">‚ùå Network error: ${err.message}</div>`;
      }
    });

    // Excel Upload Handler
    document.getElementById("excel-upload-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const fileInput = document.getElementById("excel-file");
      const resultDiv = document.getElementById("upload-result");
      
      if (!fileInput.files[0]) {
        resultDiv.innerHTML = "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel";
        return;
      }
      
      const formData = new FormData();
      formData.append("file", fileInput.files[0]);
      
      resultDiv.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
      
      try {
        const response = await fetch("/upload-traffic-excel", {
          method: "POST",
          body: formData
        });
        
        const data = await response.json();
        
        if (data.error) {
          resultDiv.innerHTML = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${data.error}`;
        } else {
          resultDiv.innerHTML = `
            <div class="success-message">
              <h4>‚úÖ ${data.message}</h4>
              <p>üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${data.total_rows}</p>
              <p>‚úÖ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${data.successful_predictions}</p>
              <p>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${data.errors}</p>
              <a href="${data.download_url}" class="download-btn" download>üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</a>
            </div>
            <div class="preview-results">
              <h5>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (10 ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å):</h5>
              <pre>${JSON.stringify(data.results, null, 2)}</pre>
            </div>
          `;
        }
      } catch (err) {
        resultDiv.innerHTML = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`;
      }
    });
  </script>
</body>
</html>
